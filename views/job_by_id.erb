<!-- Constultant Selection Modal -->
<div class="modal fade" id="SendToConsultant" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title" id="myModalLabel">Select consultant to send the posting to:</h4>
      </div>
      <div class="modal-body">
        <!-- Populate Consultants to select -->
        <form id="SendToConsultantForm" class="form-horizontal">
          <fieldset>
            <select name="ConsultantEmail" class="form-control">
              <% consultants.each do |email| %>
              <option><%= email %></option>
              <% end %>
            </select>
            <p></p>
            <textarea name="ConsultantEmailNotes" class="form-control" rows="3"></textarea>
            <p id="SendToConsultantFormLabel" class="text-center"></p>
          </fieldset>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button id="SendToConsultantButton" type="button" class="btn btn-primary">Send</button>
      </div>
    </div>
  </div>
</div>

<!-- Actual Container -->
<div class="container theme-showcase" role="main">
  <div class="page-header">
    <h2>Job Posting <small><%= job.title %></small></h2>
  </div>
  <div class="row-fluid">
    <div class="span8">
      <div class="jumbotron">
        <table class="table table-hover">
          <tr>
            <th>Job Headers</th>
            <th>Content</th>
          </tr>
          <% %w(date_posted title company location skills emails phone_nums).each do |method_name| %>
          <tr>
            <td><%= method_name %></td>
            <% method_data = job.send(method_name) %>
            <td><%= method_data.is_a?(Array) ? method_data.join(',') : method_data %></td>
          </tr>
          <% end %>
        </table>
        <div class="btn-group">
          <div class="btn-group">
            <a class="btn btn-primary btn-md" role="button" id="gobackinternal">Go Back</a>
          </div>
          <div class="btn-group">
            <a class="btn btn-primary btn-md" role="button" href="<%= job.url %>">Goto Source</a>
            <!-- <a class="btn btn-primary btn-md" role="button" data-toggle="modal" href="<%= job.url %>" data-target="#loadRemotePage">Load Source</a> -->
          </div>
          <div class="btn-group dropup">
            <button type="button" class="btn btn-primary btn-md">Actions</button>
            <button type="button" class="btn btn-primary btn-md dropdown-toggle" data-toggle="dropdown">
              <span class="caret"></span>
            </button>
            <ul class="dropdown-menu" role="menu">
              <li><a id="SEND_VENDOR">Send to Vendor</a></li>
              <li><a id="SEND_CONSULTANT" data-toggle="modal" href="#SendToConsultant">Send to Consultant</a></li>
              <li><a id="CHECK_LATER">Check Later</a></li>
              <li><a id="FOLLOW_UP">Add to Follow Up List</a></li>
              <li class="divider"></li>
              <li><a id="FORGET_POST">Forget this posting</a></li>
            </ul>
          </div>
        </div> <!-- btn-group -->
      </div> <!-- jumbotron -->
    </div>
    <div class="span4">
      <div class="panel panel-primary">
        <div class="panel-heading">Who are tracking:</div>
        <div class="panel-body">
          <ul class="list-group">
            <% tracking.each do |application| %>
            <li class="list-group-item">
              <% if application.status.include?('APPLIED') %>
              <span class="badge alert-danger">APPLIED</span>
              <% end %>
              <a href="/consultant/view/<%= application.consultant_id %>"><%= application.consultant_id %></a>
            </li>
            <% end %>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">
  // sessionStorage.setItem('JobPostingVisited', 'True');
  var url = document.URL;
  console.log("url: " + url)
  var job_id = url.substring(url.lastIndexOf('/') + 1);
  console.log("job_id: " + job_id)
  $('#gobackinternal').click(function() {
    $.ajax({
      type: "POST",
      url: "/job/" + job_id + "/read",
      success: function(data){
        // on sucess go back to the previous page
        history.go(-1);
      },
      error: function(e){
        alert("Error occurred");
      }
    });
  });
  $('#FOLLOW_UP').click(function() {
    $.ajax({
      type: "POST",
      url: "/job/" + job_id + "/follow_up",
      success: function(data){
        history.go(-1);
      },
      error: function(e){
        alert("Error occurred");
      }
    });
  });
  $('#SEND_VENDOR').click(function() {
    $.ajax({
      type: "POST",
      url: "/job/" + job_id + "/send_vendor",
      success: function(data){
        history.go(-1);
      },
      error: function(e){
        alert("Error occurred");
      }
    });
  });
  $('#SendToConsultantButton').click(function(){
    var email = $('select[name="ConsultantEmail"]').val();
    var notes = $('textarea[name="ConsultantEmailNotes"]').val();
    console.log(email);
    $('#SendToConsultantFormLabel').html('Sending email & updating user...');
    $.ajax({
      type: "POST",
      url: "/consultant/send_posting/" + email + "/" + job_id,
      data: { 'notes': notes },
      success: function(data) {
        $('#SendToConsultantFormLabel').addClass('text-info').html('Sucessfully sent email');
        $('#SendToConsultant').modal('hide');
        history.go(-1);
      },
      error: function(e) {
        $('#SendToConsultantFormLabel').addClass('text-danger').html('Something went wrong sending email!!!');
      }
    });
  });
  $('#CHECK_LATER').click(function() {
    $.ajax({
      type: "POST",
      url: "/job/" + job_id + "/check_later",
      success: function(data){
        history.go(-1);
      },
      error: function(e){
        alert("Error occurred");
      }
    });
  });
  $('#FORGET_POST').click(function() {
    $.ajax({
      type: "POST",
      url: "/job/" + job_id + "/forget",
      success: function(data){
        history.go(-1);
      },
      error: function(e){
        alert("Error occurred");
      }
    });
  });
</script>
